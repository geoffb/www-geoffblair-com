<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="description" content="Create a rain effect with drops and splashes using the HTML5 canvas element and JavaScript."><meta name="keywords" content="html5, canvas, rain, effect, drops, splash, games, gamedev, game development, javascript"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Rain Effect in HTML5 Canvas</title><link href="/media/stylesheets/combo.css" rel="stylesheet" type="text/css"><link href="/media/stylesheets/prism.css" rel="stylesheet" type="text/css"></head><body><header><div class="content"><nav><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/resume">Resume</a></li></ul></nav></div></header><main class="article"><h1>Rain Effect in HTML5 Canvas</h1><p class="date">April 13, 2016</p><ul class="tags"><li>post</li><li>html5</li><li>canvas</li><li>javascript</li><li>gamedev</li></ul><div><p>While developing an outdoor environment for <a href="http://store.steampowered.com/app/373470">A Wizard's Lizard: Soul Thief</a>, I wanted to create a rain effect to give the area a distinct feel.</p>
<p>Check out the video below to see the rain effect in action:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/EhVvrf5ahew" frameborder="0" allowfullscreen></iframe>
<p>This effect is fairly simple to create so let's dive in to how it works. We're not going to cover every single line of code in this post, but you can check out the <a href="https://github.com/geoffb/canvas-rain-demo">full source on GitHub</a>.</p>
<p>The basic concept is to manage a collection of drops which have a few properties:</p>
<ul>
<li>A point in 2D space (x, y)</li>
<li>Velocity</li>
<li>Length</li>
<li>Opacity</li>
</ul>
<p>By varying the velocity, length, and opacity, we get drops that aren't completely uniform and feel a bit more natural. For each drop, these same properties are scaled together so that drops with higher velocity are also longer and less transparent which gives the illusion of depth.</p>
<hr>
<h2>Initializing Drops</h2>
<p>Let's take a look at how we initialize our drops:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Collection of rain drops</span><br><span class="token keyword">var</span> drops <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token function-variable function">initDrops</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">DROP_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> drop <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token function">resetDrop</span><span class="token punctuation">(</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    drop<span class="token punctuation">.</span>y <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">randomInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stage<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    drops<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Reset a drop to the top of the canvas</span><br><span class="token keyword">var</span> <span class="token function-variable function">resetDrop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> scale <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  drop<span class="token punctuation">.</span>x <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">randomInteger</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">DROP_X_BUFFER</span><span class="token punctuation">,</span> stage<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token constant">DROP_X_BUFFER</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  drop<span class="token punctuation">.</span>vx <span class="token operator">=</span> <span class="token constant">WIND_VELOCITY</span><span class="token punctuation">;</span><br>  drop<span class="token punctuation">.</span>vy <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span><span class="token constant">DROP_MIN_VELOCITY</span><span class="token punctuation">,</span> <span class="token constant">DROP_MAX_VELOCITY</span><span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  drop<span class="token punctuation">.</span>l <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span><span class="token constant">DROP_MIN_LENGTH</span><span class="token punctuation">,</span> <span class="token constant">DROP_MAX_LENGTH</span><span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  drop<span class="token punctuation">.</span>a <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span><span class="token constant">DROP_MIN_ALPHA</span><span class="token punctuation">,</span> <span class="token constant">DROP_MAX_ALPHA</span><span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  drop<span class="token punctuation">.</span>y <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">randomInteger</span><span class="token punctuation">(</span><span class="token operator">-</span>drop<span class="token punctuation">.</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Notice that we create all the drops at once in <code>initDrops</code> and we have a separate function <code>resetDrop</code> which resets the state of a drop. This allows us to reuse the drop object once it reaches the bottom of the screen instead of destroying it and creating a new object.</p>
<p>During init, we also randomize the drop's Y value so that the drops are spread out along the Y axis from the start instead of always starting at the top when the effect begins.</p>
<p>We have a couple math helper functions here, too. <code>math.randomInteger</code> is pretty straight-forward and simply returns an integer between a min and max. We use this to randomize the placement of the drop along the X axis. <code>math.lerp</code> is a <a href="https://en.wikipedia.org/wiki/Linear_interpolation">linear interpolation</a> function and is used to scale a drop's velocity, length, and opacity by some normal value (between 0 and 1).</p>
<hr>
<h2>Updating Drops</h2>
<p>In order for the rain effect to animate we need to update the drops each frame. We use <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame"><code>requestAnimationFrame</code></a> to receive a callback to update and render our drops.</p>
<p>The <code>updateDrops</code> function is very simple. Loop over each drop and update its position based on velocity. If the drop is off the screen, reset it.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">updateDrops</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">dt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> drops<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> drop <span class="token operator">=</span> drops<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    drop<span class="token punctuation">.</span>x <span class="token operator">+=</span> drop<span class="token punctuation">.</span>vx <span class="token operator">*</span> dt<span class="token punctuation">;</span><br>    drop<span class="token punctuation">.</span>y <span class="token operator">+=</span> drop<span class="token punctuation">.</span>vy <span class="token operator">*</span> dt<span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>drop<span class="token punctuation">.</span>y <span class="token operator">></span> stage<span class="token punctuation">.</span>height <span class="token operator">+</span> drop<span class="token punctuation">.</span>l<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">resetDrop</span><span class="token punctuation">(</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<hr>
<h2>Rendering Drops</h2>
<p>The final step is to render the drops to the canvas. We loop over the drops again and use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo">canvas line drawing APIs</a> draw them.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">renderDrops</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token constant">DROP_COLOR</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token constant">DROP_WIDTH</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>compositeOperation <span class="token operator">=</span> <span class="token string">"lighter"</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> drops<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> drop <span class="token operator">=</span> drops<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">var</span> x1 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>drop<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> y1 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>drop<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> drop<span class="token punctuation">.</span>vx<span class="token punctuation">,</span> y<span class="token operator">:</span> drop<span class="token punctuation">.</span>vy <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    math<span class="token punctuation">.</span><span class="token function">normalizeVector</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    math<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token operator">-</span>drop<span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">var</span> x2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>x1 <span class="token operator">+</span> v<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> y2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>y1 <span class="token operator">+</span> v<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> drop<span class="token punctuation">.</span>a<span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>The only tricky thing going on here is the calculation of the drop's start end end points. We use a little bit of vector math to accomplish this by creating a vector which represents the drop's velocity then normalizing it and scaling it by the drop's length. A normalized vector (or <a href="https://en.wikipedia.org/wiki/Unit_vector">unit vector</a>) is a vector with magnitude of 1.</p>
<hr>
<h2>Wrapping Up</h2>
<p>Here's the final rain effect:</p>
<iframe src="/sandbox/canvas-rain-demo/" width="500" height="300"></iframe>
<p>Remember to take a look at the <a href="https://github.com/geoffb/canvas-rain-demo">full source on GitHub</a> to fill in any gaps.</p>
<p>We didn't discuss splashes in this post, but they can be accomplished in a very similar manner and rendered using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc"><code>arc</code></a> canvas API.</p>
</div></main><footer><p>© Geoff Blair</p></footer><script src="/media/scripts/prism.js"></script></body></html>